<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù†Ø¨Ù‘Ù‡Ù†ÙŠ</title>
  <meta name="theme-color" content="#0A0E13">
  <link rel="stylesheet" href="/style.css">
  <link rel="icon" type="image/png" href="/icon.png">
  <style>
    /* Share page specific styles */
    .share-page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 80px 24px 40px;
      position: relative;
      z-index: 2;
      text-align: center;
    }

    .countdown-card {
      width: 100%;
      max-width: 400px;
      border-radius: var(--radius);
      padding: 40px 28px;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.12);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
    }

    .countdown-card .card-icon {
      font-size: 4rem;
      margin-bottom: 16px;
      display: block;
    }

    .countdown-card .card-title {
      font-size: 1.6rem;
      font-weight: 800;
      color: #fff;
      margin-bottom: 8px;
    }

    .countdown-card .card-date {
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 28px;
    }

    .countdown-card .card-sharer {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 20px;
    }

    .timer-grid {
      display: flex;
      gap: 12px;
      justify-content: center;
      direction: ltr;
    }

    .timer-unit {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 60px;
    }

    .timer-value {
      font-size: 2.2rem;
      font-weight: 800;
      color: #fff;
      line-height: 1;
      font-variant-numeric: tabular-nums;
    }

    .timer-label {
      font-size: 0.7rem;
      color: rgba(255, 255, 255, 0.6);
      margin-top: 6px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .timer-separator {
      font-size: 2rem;
      font-weight: 800;
      color: rgba(255, 255, 255, 0.3);
      line-height: 1;
      align-self: flex-start;
    }

    .timer-done {
      font-size: 1.4rem;
      font-weight: 800;
      color: #fff;
    }

    .share-actions {
      margin-top: 32px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 14px;
      width: 100%;
      max-width: 400px;
    }

    .share-actions .btn-primary,
    .share-actions .btn-secondary {
      width: 100%;
      justify-content: center;
    }

    .share-branding {
      margin-top: 32px;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .share-branding img {
      width: 28px;
      height: 28px;
      border-radius: 6px;
    }

    .share-branding span {
      font-weight: 700;
      color: var(--text-secondary);
    }

    .store-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
      width: 100%;
    }

    .store-buttons .btn-primary,
    .store-buttons .btn-secondary {
      flex: 1;
      min-width: 150px;
      justify-content: center;
    }

    /* 404 specific */
    .error-icon {
      font-size: 5rem;
      margin-bottom: 20px;
      display: block;
    }

    .error-title {
      font-size: 2rem;
      font-weight: 800;
      margin-bottom: 12px;
    }

    .error-subtitle {
      font-size: 1.1rem;
      color: var(--text-secondary);
      margin-bottom: 32px;
      max-width: 400px;
    }

    /* Countdown ended state */
    .celebration-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 18px;
      background: rgba(52, 211, 153, 0.15);
      border: 1px solid rgba(52, 211, 153, 0.3);
      border-radius: 100px;
      font-size: 0.9rem;
      color: var(--green);
      font-weight: 700;
    }

    @media (max-width: 640px) {
      .countdown-card {
        padding: 32px 20px;
      }

      .countdown-card .card-title {
        font-size: 1.3rem;
      }

      .timer-value {
        font-size: 1.8rem;
      }

      .timer-unit {
        min-width: 48px;
      }

      .timer-separator {
        font-size: 1.6rem;
      }

      .store-buttons {
        flex-direction: column;
      }

      .store-buttons .btn-primary,
      .store-buttons .btn-secondary {
        min-width: unset;
      }
    }
  </style>
</head>
<body>

  <!-- Background Effects -->
  <div class="bg-effects">
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>
  </div>
  <div class="grain"></div>

  <!-- Navigation -->
  <nav class="navbar">
    <div class="container">
      <a href="/" class="nav-logo">
        <img src="/icon.png" alt="Ù†Ø¨Ù‘Ù‡Ù†ÙŠ" onerror="this.style.display='none'">
        <span>Ù†Ø¨Ù‘Ù‡Ù†ÙŠ</span>
      </a>
    </div>
  </nav>

  <div id="page-root"></div>

  <script>
    // Theme color map (matches constants/themes.ts)
    var THEMES = {
      default:  { bg: ['#0f0c29', '#302b63', '#24243e'] },
      sunset:   { bg: ['#ff6b6b', '#ff8e53', '#feca57'] },
      night:    { bg: ['#03045e', '#0077b6', '#00b4d8'] },
      gold:     { bg: ['#1a1a2e', '#16213e', '#0f3460'] },
      ramadan:  { bg: ['#004d40', '#00695c', '#00897b'] }
    };

    // App Store SVG icon
    var APPLE_SVG = '<svg viewBox="0 0 24 24"><path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.8-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/></svg>';

    // Google Play SVG icon
    var PLAY_SVG = '<svg viewBox="0 0 24 24"><path d="M3.176 2.098a1.007 1.007 0 0 0-.176.57v18.664c0 .21.063.403.176.57L12.924 12 3.176 2.098zm.924-.822L14.558 7.85l-2.634 2.634L4.1 1.276zm0 21.448l7.824-9.208L14.558 16.15 4.1 22.724zM20.824 12c0-.37-.197-.712-.524-.898l-3.99-2.308-2.886 2.886 2.886 2.886 3.99-2.308c.327-.186.524-.528.524-.898v-.26z"/></svg>';

    /**
     * Decode shared countdown data from URL-safe base64.
     * Mirrors lib/shareLink.ts decodeSharedCountdown().
     */
    function decodeCountdown(encoded) {
      try {
        // Restore base64 from URL-safe variant
        var base64 = encoded.replace(/-/g, '+').replace(/_/g, '/');
        // Add back padding
        while (base64.length % 4) base64 += '=';
        // base64 -> decodeURIComponent -> JSON
        var decoded = atob(base64);
        var jsonStr = decodeURIComponent(decoded);
        var data = JSON.parse(jsonStr);
        // Validate required fields
        if (!data.t || !data.d || !data.i || !data.th) return null;
        // Validate date
        if (isNaN(new Date(data.d).getTime())) return null;
        return {
          title: data.t,
          targetDate: data.d,
          icon: data.i,
          theme: data.th,
          sharerName: data.n || null
        };
      } catch (e) {
        return null;
      }
    }

    /** Format a date in Arabic locale */
    function formatDate(isoDate) {
      try {
        var d = new Date(isoDate);
        return d.toLocaleDateString('ar-SA', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
      } catch (e) {
        return isoDate;
      }
    }

    /** Compute time remaining */
    function getTimeRemaining(targetDate) {
      var now = Date.now();
      var target = new Date(targetDate).getTime();
      var diff = target - now;
      if (diff <= 0) return null;
      return {
        days: Math.floor(diff / (1000 * 60 * 60 * 24)),
        hours: Math.floor((diff / (1000 * 60 * 60)) % 24),
        minutes: Math.floor((diff / (1000 * 60)) % 60),
        seconds: Math.floor((diff / 1000) % 60)
      };
    }

    /** Pad number with leading zero */
    function pad(n) { return n < 10 ? '0' + n : '' + n; }

    /** Get gradient CSS for a theme */
    function themeGradient(themeId) {
      var t = THEMES[themeId] || THEMES['default'];
      return 'linear-gradient(135deg, ' + t.bg.join(', ') + ')';
    }

    /** Build store buttons HTML */
    function storeButtonsHTML() {
      return '<div class="store-buttons">' +
        '<a href="#" class="btn-primary">' + APPLE_SVG + ' App Store</a>' +
        '<a href="#" class="btn-secondary">' + PLAY_SVG + ' Google Play</a>' +
      '</div>';
    }

    /** Build branding HTML */
    function brandingHTML() {
      return '<div class="share-branding">' +
        '<img src="/icon.png" alt="" onerror="this.style.display=\'none\'">' +
        '<span>Ù†Ø¨Ù‘Ù‡Ù†ÙŠ</span> â€” ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ' +
      '</div>';
    }

    // ========== ROUTE HANDLING ==========

    var path = window.location.pathname;
    var root = document.getElementById('page-root');

    // Route: /s/{encoded_data} â€” Shared countdown preview
    var shareMatch = path.match(/^\/s\/([^/?]+)/);
    // Route: /c/{id} â€” Countdown by ID
    var countdownMatch = path.match(/^\/c\/([^/?]+)/);

    if (shareMatch) {
      renderSharePage(shareMatch[1]);
    } else if (countdownMatch) {
      renderCountdownIdPage(countdownMatch[1]);
    } else {
      render404Page();
    }

    /** Render shared countdown preview */
    function renderSharePage(encoded) {
      var data = decodeCountdown(encoded);

      if (!data) {
        // Could not decode â€” show fallback
        renderDecodeFallback();
        return;
      }

      // Update page title and OG meta
      document.title = data.icon + ' ' + data.title + ' â€” Ù†Ø¨Ù‘Ù‡Ù†ÙŠ';
      updateMeta('og:title', data.icon + ' ' + data.title);
      updateMeta('og:description', 'Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù„Ù€ ' + data.title + ' â€” ' + formatDate(data.targetDate));

      var remaining = getTimeRemaining(data.targetDate);
      var gradient = themeGradient(data.theme);
      var deepLink = 'nabbihni://shared/' + encoded;

      var html = '<div class="share-page">' +
        '<div class="countdown-card" style="background: ' + gradient + '">' +
          '<span class="card-icon">' + escapeHTML(data.icon) + '</span>' +
          '<div class="card-title">' + escapeHTML(data.title) + '</div>' +
          '<div class="card-date">' + formatDate(data.targetDate) + '</div>' +
          (data.sharerName ? '<div class="card-sharer">Ø´Ø§Ø±ÙƒÙ‡ ' + escapeHTML(data.sharerName) + '</div>' : '') +
          (remaining
            ? '<div class="timer-grid" id="live-timer">' + timerHTML(remaining) + '</div>'
            : '<div class="celebration-badge">&#127881; Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ!</div>') +
        '</div>' +
        '<div class="share-actions">' +
          '<a href="' + deepLink + '" class="btn-primary" id="open-app-btn">Ø§ÙØªØ­ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</a>' +
          storeButtonsHTML() +
        '</div>' +
        brandingHTML() +
      '</div>';

      root.innerHTML = html;

      // Start live timer
      if (remaining) {
        setInterval(function () {
          var r = getTimeRemaining(data.targetDate);
          var el = document.getElementById('live-timer');
          if (!el) return;
          if (r) {
            el.innerHTML = timerHTML(r);
          } else {
            el.innerHTML = '<div class="celebration-badge">&#127881; Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ!</div>';
          }
        }, 1000);
      }
    }

    /** Timer display HTML */
    function timerHTML(r) {
      return '<div class="timer-unit"><span class="timer-value">' + pad(r.days) + '</span><span class="timer-label">ÙŠÙˆÙ…</span></div>' +
        '<span class="timer-separator">:</span>' +
        '<div class="timer-unit"><span class="timer-value">' + pad(r.hours) + '</span><span class="timer-label">Ø³Ø§Ø¹Ø©</span></div>' +
        '<span class="timer-separator">:</span>' +
        '<div class="timer-unit"><span class="timer-value">' + pad(r.minutes) + '</span><span class="timer-label">Ø¯Ù‚ÙŠÙ‚Ø©</span></div>' +
        '<span class="timer-separator">:</span>' +
        '<div class="timer-unit"><span class="timer-value">' + pad(r.seconds) + '</span><span class="timer-label">Ø«Ø§Ù†ÙŠØ©</span></div>';
    }

    /** Fallback when decode fails */
    function renderDecodeFallback() {
      document.title = 'Ø¹Ø¯ ØªÙ†Ø§Ø²Ù„ÙŠ Ù…Ø´ØªØ±Ùƒ â€” Ù†Ø¨Ù‘Ù‡Ù†ÙŠ';

      root.innerHTML = '<div class="share-page">' +
        '<span class="error-icon">â³</span>' +
        '<div class="error-title">Ø±Ø§Ø¨Ø· Ø¹Ø¯ ØªÙ†Ø§Ø²Ù„ÙŠ</div>' +
        '<div class="error-subtitle">Ø­Ù…Ù‘Ù„ ØªØ·Ø¨ÙŠÙ‚ Ù†Ø¨Ù‘Ù‡Ù†ÙŠ Ù„Ø¹Ø±Ø¶ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ</div>' +
        '<div class="share-actions">' + storeButtonsHTML() + '</div>' +
        brandingHTML() +
      '</div>';
    }

    /** Render /c/{id} page â€” countdown by ID needs the app */
    function renderCountdownIdPage(id) {
      document.title = 'Ø¹Ø¯ ØªÙ†Ø§Ø²Ù„ÙŠ â€” Ù†Ø¨Ù‘Ù‡Ù†ÙŠ';

      root.innerHTML = '<div class="share-page">' +
        '<span class="error-icon">â³</span>' +
        '<div class="error-title">Ø¹Ø¯ ØªÙ†Ø§Ø²Ù„ÙŠ Ù…Ø´ØªØ±Ùƒ</div>' +
        '<div class="error-subtitle">Ø­Ù…Ù‘Ù„ ØªØ·Ø¨ÙŠÙ‚ Ù†Ø¨Ù‘Ù‡Ù†ÙŠ Ù„Ø¹Ø±Ø¶ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ ÙˆÙ…ØªØ§Ø¨Ø¹ØªÙ‡</div>' +
        '<div class="share-actions">' + storeButtonsHTML() + '</div>' +
        brandingHTML() +
      '</div>';
    }

    /** Render 404 page */
    function render404Page() {
      document.title = 'Ø§Ù„ØµÙØ­Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© â€” Ù†Ø¨Ù‘Ù‡Ù†ÙŠ';

      root.innerHTML = '<div class="share-page">' +
        '<span class="error-icon">ğŸ”</span>' +
        '<div class="error-title">Ø§Ù„ØµÙØ­Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©</div>' +
        '<div class="error-subtitle">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù„ÙŠ ØªØ¨Ø­Ø« Ø¹Ù†Ù‡Ø§ Ù…Ùˆ Ù…ÙˆØ¬ÙˆØ¯Ø©. ÙŠÙ…ÙƒÙ† Ø§Ù„Ø±Ø§Ø¨Ø· Ø®Ø·Ø£ Ø£Ùˆ Ø§Ù„ØµÙØ­Ø© Ø§Ù†Ø­Ø°ÙØª.</div>' +
        '<div class="share-actions">' +
          '<a href="/" class="btn-primary">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>' +
          storeButtonsHTML() +
        '</div>' +
        brandingHTML() +
      '</div>';
    }

    /** Escape HTML to prevent XSS */
    function escapeHTML(str) {
      var div = document.createElement('div');
      div.appendChild(document.createTextNode(str));
      return div.innerHTML;
    }

    /** Update or create meta tags */
    function updateMeta(property, content) {
      var meta = document.querySelector('meta[property="' + property + '"]');
      if (meta) {
        meta.setAttribute('content', content);
      } else {
        meta = document.createElement('meta');
        meta.setAttribute('property', property);
        meta.setAttribute('content', content);
        document.head.appendChild(meta);
      }
    }
  </script>

</body>
</html>
